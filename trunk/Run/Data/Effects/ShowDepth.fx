#include "Globals.fx"
#include "Functions.fx"

sampler DepthTextureSampler : register(s0) = sampler_state
{
  MipFilter = LINEAR;
  MinFilter = LINEAR;  
  MagFilter = LINEAR;
  AddressU  = WRAP;
  AddressV  = WRAP;
};

sampler PosTextureSampler : register(s1) = sampler_state
{
  MipFilter = LINEAR;
  MinFilter = LINEAR;  
  MagFilter = LINEAR;
  AddressU  = WRAP;
  AddressV  = WRAP;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

float LinearizeDepth(float2 uv)
{
  //float n = 1; // camera z near
  //float f = 100; // camera z far
  //float z = tex2D(PrevFilterSampler, uv).x;
  //return 1.0 - (2.0 * n) / (f + n - z * (f - n));
  float z = tex2D(DepthTextureSampler, uv).x;
  //return frac(z);
  return z / 100;
}

float4 ShowDepthPS(float2 _UV: TEXCOORD0) : COLOR
{
  float d;
  d = LinearizeDepth(_UV);
  
  return float4(d,d,d,1.0);
}

technique ShowDepthTechnique
{
	pass p0
	{
		ZEnable = false;
		ZWriteEnable = false;
		AlphaBlendEnable = false;
		CullMode = CCW;
		PixelShader = compile ps_3_0 ShowDepthPS();
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


float4 ShowComputedPosPS(float2 _UV: TEXCOORD0) : COLOR
{
  
  float z = tex2D(DepthTextureSampler, _UV).x;
  
  float3 xyz = PositionFromZ(z,_UV);
  
  return float4(frac(xyz), 1.0);
}

technique ShowComputedPosTechnique
{
	pass p0
	{
		ZEnable = false;
		ZWriteEnable = false;
		AlphaBlendEnable = false;
		CullMode = CCW;
		PixelShader = compile ps_3_0 ShowComputedPosPS();
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


float4 ShowRealPosPS(float2 _UV: TEXCOORD0) : COLOR
{
  
  float3 xyz;
  xyz.z = tex2D(DepthTextureSampler, _UV).x;
  
  xyz.xy = tex2D(PosTextureSampler, _UV).xy;
  
  return float4(frac(xyz), 1.0);
}

technique ShowRealPosTechnique
{
	pass p0
	{
		ZEnable = false;
		ZWriteEnable = false;
		AlphaBlendEnable = false;
		CullMode = CCW;
		PixelShader = compile ps_3_0 ShowRealPosPS();
	}
}